<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>code-n-go // Robotech</title>
    <link rel="stylesheet" href="static/style.css">
    
    <script src="static/blockly_compressed.js"></script>
    <script src="static/blocks_compressed.js"></script>
    <script src="static/python_compressed.js"></script>
    <script src="static/pl.js"></script>
    
    <script src="/static/blockly_blocks.js"></script>
    <script src="/static/blockly_python.js"></script>
    <!-- app.js musi być na samym dole w <body>, tuż przed </body> -->
    <style>
            #loader {
                position: fixed;
                top: 0; left: 0;
                width: 100vw; height: 100vh;
                background: #2c3e50; /* Ciemne tło pasuje do S3 */
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 99999; /* Musi być wyżej niż menu i Blockly */
                transition: opacity 0.5s ease-out;
            }

            #loader-msg {
                color: #bdc3c7;
                margin-top: 20px;
                font-family: sans-serif;
                letter-spacing: 1px;
            }
            /* Kontener Loadera */
            #loader {
                position: fixed;
                top: 0; left: 0;
                width: 100%; height: 100%;
                background: #2c3e50; /* Ciemny granat Robotech */
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 99999;
                transition: opacity 0.5s ease;
            }

            /* Tekst pod puzzlami */
            .loader-text {
                color: white;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                margin-top: 20px;
                letter-spacing: 4px;
                font-size: 1.2rem;
            }

            /* KLUCZ: Animacja SVG */
            .puzzle-svg {
                overflow: visible;
            }

            .piece {
                opacity: 0;
                /* transition definuje powrót, transform-origin środek dla obrotu */
                transform-origin: center;
            }

            /* Definicja lotu dla każdego kawałka */
            @keyframes assemble {
                0% {
                    opacity: 0;
                    transform: translate(var(--dx), var(--dy)) rotate(var(--dr));
                }
                100% {
                    opacity: 1;
                    transform: translate(0, 0) rotate(0deg);
                }
            }

            /* Każdy kawałek ma inne parametry startowe */
            .p1 { --dx: -150px; --dy: -150px; --dr: -45deg;  animation: assemble 0.8s 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
            .p2 { --dx: 150px;  --dy: -150px; --dr: 45deg;   animation: assemble 0.8s 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
            .p3 { --dx: -150px; --dy: 150px;  --dr: -90deg;  animation: assemble 0.8s 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
            .p4 { --dx: 150px;  --dy: 150px;  --dr: 90deg;   animation: assemble 0.8s 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

            /* Efekt pulsowania całego logo po złożeniu */
            .puzzle-svg {
                animation: pulse 2s 1.5s infinite ease-in-out;
            }

            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.05); }
                100% { transform: scale(1); }
            }

    </style>

</head>
<body>
    <!-- LOADER -->
    <div id="loader">
        <svg width="120" height="120" viewBox="0 0 110 130" class="puzzle-svg">
            <rect class="piece p1" x="5" y="5" width="45" height="45" rx="8" fill="#e67e22" />
            <rect class="piece p2" x="55" y="5" width="45" height="45" rx="8" fill="#d35400" />
            <rect class="piece p3" x="5" y="55" width="45" height="45" rx="8" fill="#d35400" />
            <rect class="piece p4" x="55" y="55" width="45" height="45" rx="8" fill="#e67e22" />
            <text x="55" y="125" text-anchor="middle" fill="white" style="font: bold 14px sans-serif; letter-spacing: 2px;">ROBOTECH</text>
        </svg>
        <p id="loader-msg">Inicjalizacja ESP32-S3...</p>
    </div>

    <!-- RESZTA  -->

    <div id="header">
        <div class="tabs">
            <div id="tab-blocks" class="tab active" onclick="switchTab('blocks')">Blockly</div>
            <div id="tab-python" class="tab" onclick="switchTab('python')">Python</div>
            <div id="tab-panel" class="tab" onclick="switchTab('panel')">Panel</div>
            <div id="tab-pilot" class="tab" onclick="switchTab('pilot')">Pad</div>
        </div>
        <div class="dropdown">
            <div class="tab menu-trigger">Plik ▼</div>
            <div class="dropdown-content">
                <a href="#" class="menu-item" onclick="newProject()">Nowy</a>
                <a href="#" class="menu-item" onclick="saveProject()">Zapisz</a>
                <a href="#" class="menu-item" onclick="listProjects()">Otwórz</a>
                <hr>
                <a href="#" class="menu-item" onclick="loadExample()">Przykłady...</a>																									
            </div>
        </div>
        <button class="btn-run" onclick="runCode()">START ▶</button>
    </div>

    
    <div id="blocklyDiv"></div>

    <div id="pythonDiv" style="display:none; flex-grow:1; background:#1e1e1e; width:100%; height:100%;">
        <div id="pythonContainer" style="display:flex; width:100%; height:100%; font-family:monospace;">
            <!-- Numery linii: wąskie -->
            <div id="lineNumbers" style="padding:10px 5px; background:#252526; color:#858585; text-align:right; min-width:35px; border-right:1px solid #333; font-size:14px; line-height:1.5;">1</div>
            <!-- Edytor: zajmuje całą resztę (flex-grow: 1) -->
            <textarea id="pythonEditor" spellcheck="false" style="flex-grow:1; width:100%; background:transparent; color:#d4d4d4; border:none; padding:10px; resize:none; outline:none; font-size:14px; line-height:1.5; white-space:pre;"></textarea>
        </div>
    </div>


    <div id="panelDiv">
        <h3>MOJE PRZYCISKI</h3>
        <div id="customButtons"></div>
    </div>

    <div id="pilotDiv">
        <div class="pad-grid">
            <!-- Rząd 1 (Góra): 7(1), 8(Góra), 9(3) -->
            <button class="btn-action" onclick="sendJoy('1')">1</button>
            <button class="btn-joy" onclick="sendJoy('GÓRA')">▲</button>
            <button class="btn-action" onclick="sendJoy('3')">3</button>

            <!-- Rząd 2 (Środek): 4(Lewo), 5(STOP), 6(Prawo) -->
            <button class="btn-joy" onclick="sendJoy('LEWO')">◀</button>
            <button class="btn-stop" onclick="sendJoy('STOP')">■</button>
            <button class="btn-joy" onclick="sendJoy('PRAWO')">▶</button>

            <!-- Rząd 3 (Dół): 1(2), 2(Dół), 3(4) -->
            <button class="btn-action" onclick="sendJoy('2')">2</button>
            <button class="btn-joy" onclick="sendJoy('DÓŁ')">▼</button>
            <button class="btn-action" onclick="sendJoy('4')">4</button>
        </div>
    </div>
    
    <!-- Modal do wyboru plików -->
    <div id="fileModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10000; justify-content:center; align-items:center;">
        <div style="background:#2c3e50; padding:20px; border-radius:15px; width:80%; max-width:300px; color:white; text-align:center;">
            <h3>Otwórz projekt</h3>
            <div id="fileList" style="max-height:200px; overflow-y:auto; margin:15px 0; border:1px solid #555; border-radius:5px;">
                <!-- Tu wskoczą pliki -->
            </div>
            <button onclick="document.getElementById('fileModal').style.display='none'" style="background:#e74c3c; color:white; border:none; padding:10px; border-radius:5px; cursor:pointer;">Anuluj</button>
        </div>
    </div>

    <xml id="toolbox" style="display: none">
        <category name="Robot" colour="#e67e22">
            <block type="pilot_add_button"></block>
            <block type="pilot_on_joy"></block>
            <block type="led_on"></block>
            <block type="led_off"></block>
            <block type="wait_ms"></block>
            <block type="servo_move">
                <field name="PIN">27</field>
                <field name="ANGLE">90</field>
            </block>
        </category>
        
        <category name="Ekran" colour="#3498db">
            <block type="screen_print">
                <field name="MSG">Hej Robo!</field>
                <field name="LINE">0</field>
                <field name="COL">0x07E0</field>
            </block>
            <block type="screen_rect">
                <field name="X">10</field>
                <field name="Y">10</field>
                <field name="W">100</field>
                <field name="H">50</field>
                <field name="COL">0xF800</field>
            </block>
            <block type="screen_clear"></block>
        </category>
        
        <category name="Logika" colour="#5b80a5">
            <block type="controls_if"></block>
        </category>
        
        <category name="Pętle" colour="#5ba55b">
            <block type="controls_repeat_ext">
                <value name="TIMES">
                    <shadow type="math_number">
                        <field name="NUM">10</field>
                    </shadow>
                </value>
            </block>
        </category>
    </xml>

        
    <div id="statusbar">
        <span id="status-msg">Inicjalizacja systemu...</span>
        <span id="status-info">Code-n-Go OS | S3-Waveshare</span>
    </div>

    <!-- Główna logika aplikacji -->
    <script src="static/app.js"></script>
</body>
</html>